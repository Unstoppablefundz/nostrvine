<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenVine</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="main.css?v=1">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <meta name="description" content="Watch and share 6-second looping videos">
    <style>
        /* Search Results Overlay */
        .search-results-overlay {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            background: rgba(0, 0, 0, 0.9) !important;
            z-index: 9999 !important;
            overflow-y: auto;
        }
        
        .search-results-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
        }
        
        .search-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .search-header h2 {
            color: white;
            font-family: 'Pacifico', cursive;
            font-size: 2rem;
            margin: 0;
        }
        
        .close-search {
            background: none;
            border: none;
            color: white;
            font-size: 40px;
            cursor: pointer;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-search:hover {
            color: #ff6b6b;
        }
        
        .search-status {
            color: white;
            text-align: center;
            font-size: 18px;
            margin: 20px 0;
            min-height: 25px;
        }
        
        .search-results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .search-video-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            cursor: pointer;
        }
        
        .search-video-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }
        
        .search-video-thumbnail {
            width: 100%;
            height: 200px;
            background: #f0f0f0;
            position: relative;
            overflow: hidden;
        }
        
        .search-video-thumbnail video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .search-video-info {
            padding: 15px;
        }
        
        .search-video-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
            font-size: 14px;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .search-video-author {
            color: #666;
            font-size: 12px;
            margin-bottom: 8px;
        }
        
        .search-video-stats {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #999;
        }
        
        .search-section {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .search-section h3 {
            color: #333;
            margin-bottom: 15px;
        }
        
        /* Loading Animation */
        .search-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            color: white;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #00bf8f;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 18px;
            text-align: center;
        }
        
        .loading-dots::after {
            content: '';
            animation: dots 1.5s infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }
        
        /* Search box pulse animation when searching */
        .vine-search-input.searching {
            animation: searchPulse 2s ease-in-out infinite;
            border: 2px solid #00bf8f !important;
            box-shadow: 0 0 10px rgba(0, 191, 143, 0.5) !important;
        }
        
        @keyframes searchPulse {
            0%, 100% { box-shadow: 0 0 5px rgba(0, 191, 143, 0.3); }
            50% { box-shadow: 0 0 20px rgba(0, 191, 143, 0.6); }
        }
        
        /* Active category styling */
        .vine-category-item.active {
            background: #00bf8f !important;
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(0, 191, 143, 0.5);
        }
        
        /* Trending badge styling */
        .trending-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .vine-grid-item.trending {
            border: 2px solid #ff6b6b;
            box-shadow: 0 0 10px rgba(255, 107, 107, 0.3);
        }
    </style>
    
    <!-- nostr-tools (Modern ESM import) -->
    <script type="module">
        // Load nostr-tools using modern ESM import
        try {
            const NostrTools = await import("https://esm.sh/nostr-tools@2.7.0");
            const { SimplePool } = await import("https://esm.sh/nostr-tools@2.7.0/pool");
            
            console.log('Loaded modern nostr-tools');
            console.log('NostrTools:', NostrTools);
            console.log('SimplePool:', SimplePool);
            
            // Make available globally for our scripts
            window.NostrTools = NostrTools;
            window.NostrPool = SimplePool;
            
        } catch (error) {
            console.error('Failed to load nostr-tools:', error);
            console.log('Will use WebSocket fallback');
        }
    </script>
</head>
<body>
    <!-- Header -->
    <header class="vine-header">
        <div class="vine-header-bg"></div>
        <div class="vine-header-content">
            <a href="/" class="vine-logo">OpenVine</a>
            <div class="vine-auth-buttons">
                <a href="https://app.openvine.co" class="vine-auth-btn vine-login-btn">Log in</a>
                <!-- UPLOAD VIDEO BUTTON ADDED HERE -->
                <a href="https://nostr.build" target="_blank" class="vine-auth-btn">Upload Video</a>
            </div>
        </div>
        <div class="vine-hero-section">
            <h1 class="vine-tagline">Return to a world of beautiful, looping videos.</h1>
            <div class="vine-search-container">
                <input type="text" class="vine-search-input" placeholder="Search" id="vineSearchInput" onkeypress="if(event.key==='Enter')searchVinesWithOverlay()">
            </div>
            <div class="vine-app-buttons">
                <a href="/ios" class="vine-app-btn vine-ios-btn">
                    <span class="vine-app-icon">Apple</span>
                    <span>Get it on<br><strong>iOS</strong></span>
                </a>
                <a href="open-source.html" class="vine-app-btn vine-android-btn">
                    <span class="vine-app-icon">Robot</span>
                    <span>Get it on<br><strong>Android</strong></span>
                </a>
                <a href="open-source.html" class="vine-app-btn vine-windows-btn">
                    <span class="vine-app-icon">Windows</span>
                    <span>Get it on<br><strong>Windows</strong></span>
                </a>
                <a href="/macos" class="vine-app-btn vine-mac-btn">
                    <span class="vine-app-icon">Laptop</span>
                    <span>Get it for<br><strong>macOS</strong></span>
                </a>
                <a href="open-source.html" class="vine-app-btn vine-linux-btn">
                    <span class="vine-app-icon">Penguin</span>
                    <span>Get it on<br><strong>Linux</strong></span>
                </a>
            </div>
        </div>
    </header>

    <!-- Search Results Container -->
    <div id="searchResultsContainer" class="search-results-overlay" style="display: none;">
        <div class="search-results-content">
            <div class="search-header">
                <h2 id="searchResultsTitle">Search Results</h2>
                <button class="close-search" onclick="hideSearchResults()">×</button>
            </div>
            <div id="searchStatus" class="search-status"></div>
            <div id="searchResultsContent"></div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="vine-main-container">
        <!-- Left Sidebar - Categories -->
        <aside class="vine-sidebar-left">
            <div class="vine-categories">
                <h3>Channels</h3>
                <div class="vine-category-grid">
                    <!-- Row 1 -->
                    <div class="vine-category-item" onclick="showPlaylist('editors-picks')" title="Editor's Picks">Video Camera</div>
                    <div class="vine-category-item" onclick="showRisingVideos()" title="Rising Videos">Rocket</div>
                    <div class="vine-category-item" onclick="filterByCategoryWithAnalytics('comedy')" title="Comedy">Laughing Face</div>
                    <div class="vine-category-item" onclick="filterByCategoryWithAnalytics('cool')" title="Cool">Sunglasses</div>
                    
                    <!-- Row 2 -->
                    <div class="vine-category-item" onclick="filterByCategoryWithAnalytics('girls')" title="Girls">Girl</div>
                    <div class="vine-category-item" onclick="filterByCategoryWithAnalytics('guys')" title="Guys">Bearded Man</div>
                    <div class="vine-category-item" onclick="filterByCategoryWithAnalytics('gaming')" title="Gaming">Game Controller</div>
                    <div class="vine-category-item" onclick="filterByCategoryWithAnalytics('popnow')" title="Pop Now">Explosion</div>
                    
                    <!-- Row 3 -->
                    <div class="vine-category-item" onclick="filterByCategoryWithAnalytics('musicdance')" title="Music & Dance">Music Note</div>
                    <div class="vine-category-item" onclick="filterByCategoryWithAnalytics('ideas')" title="Ideas">Light Bulb</div>
                    <div class="vine-category-item" onclick="filterByCategoryWithAnalytics('trending')" title="Trending">Chart</div>
                    <div class="vine-category-item" onclick="filterByCategoryWithAnalytics('special')" title="Special">Lightning</div>
                    
                    <!-- Row 4 -->
                    <div class="vine-category-item" onclick="filterByCategoryWithAnalytics('animals')" title="Animals">Fox</div>
                    <div class="vine-category-item" onclick="filterByCategoryWithAnalytics('places')" title="Places & Travel">World Map</div>
                    <div class="vine-category-item" onclick="filterByCategoryWithAnalytics('family')" title="Family">Family</div>
                    <div class="vine-category-item" onclick="filterByCategoryWithAnalytics('artdesign')" title="Art & Design">Paint Palette</div>
                    
                    <!-- Row 5 -->
                    <div class="vine-category-item" onclick="filterByCategoryWithAnalytics('scary')" title="Scary">Skull</div>
                    <div class="vine-category-item" onclick="filterByCategoryWithAnalytics('sports')" title="Sports">Runner</div>
                    <div class="vine-category-item" onclick="filterByCategoryWithAnalytics('cars')" title="Cars">Car</div>
                    <div class="vine-category-item" onclick="filterByCategoryWithAnalytics('food')" title="Food">Burger</div>
                    
                    <!-- Row 6 -->
                    <div class="vine-category-item" onclick="filterByCategoryWithAnalytics('diy')" title="DIY">Hammer</div>
                    <div class="vine-category-item" onclick="filterByCategoryWithAnalytics('news')" title="News & Politics">Mobile Phone</div>
                    <div class="vine-category-item" onclick="filterByCategoryWithAnalytics('fashion')" title="Fashion & Beauty">Lipstick</div>
                    <div class="vine-category-item" onclick="filterByCategoryWithAnalytics('nature')" title="Nature">Mountain</div>
                </div>
            </div>
            
            <!-- About OpenVine -->
            <div class="vine-about-section">
                <h3>Welcome back</h3>
                <p>OpenVine brings back 6-second looping videos. No algorithms. No filters. Just pure, authentic creativity.</p>
                <a href="about.html" class="vine-about-link">Our story →</a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="vine-main-content">
            <!-- Video Feed Container -->
            <div class="vine-video-feed" id="vineVideoFeed">
                <!-- Videos will be dynamically loaded here -->
            </div>
        </main>
    </div>

    <script>
        // Analytics API Constants  
        const ANALYTICS_API = 'https://api.openvine.co/analytics';
        
        // Dynamic Nostr content system
        let allNostrVideos = [];      // All videos from Nostr
        let allNostrProfiles = [];    // All profiles from Nostr  
        let allNostrPlaylists = [];   // All playlists from Nostr
        let videoCategories = new Set(); // Dynamic categories from hashtags
        let isContentLoaded = false;
        let contentSubscription = null;
        
        // Load manifest data
        // Load all content dynamically from Nostr
        async function loadNostrContent() {
            console.log('Loading all content from Nostr...');
            
            try {
                // Initialize relay if needed
                const relayInstance = await initializeNostrRelay();
                if (!relayInstance) {
                    throw new Error('Failed to initialize nostr-tools relay');
                }

                console.log('Connected! Loading videos, profiles, and playlists...');

                // Close any existing subscription
                if (contentSubscription) {
                    contentSubscription.unsub();
                }

                // Create comprehensive filter for all content
                // For main feed, focus on specific user's vines
                // This is the main OpenVine content curator account
                const targetPubkey = '2d6a0f27043055948f4e2d0ff203d0112138ffd394b2a1c94f9da1d6d97f6911';
                
                const filter = {
                    kinds: [0, 22, 30023], // Profiles, Videos, Playlists
                    authors: [targetPubkey], // Load from specific user
                    limit: 1000,
                    since: Math.floor(Date.now() / 1000) - (365 * 24 * 60 * 60) // Last year to get all content
                };

                console.log('Creating subscription for all content types...');

                let eventCount = 0;
                let videoCount = 0;
                let profileCount = 0;
                let playlistCount = 0;

                // Create subscription
                contentSubscription = relayInstance.sub([filter]);

                // Handle events
                contentSubscription.on('event', (event) => {
                    eventCount++;
                    
                    if (event.kind === 0) { // Profile
                        profileCount++;
                        const profile = processNostrProfile(event);
                        if (profile && !allNostrProfiles.find(p => p.pubkey === profile.pubkey)) {
                            allNostrProfiles.push(profile);
                        }
                    } else if (event.kind === 22) { // Video
                        videoCount++;
                        const video = processNostrVideo(event);
                        if (video && !allNostrVideos.find(v => v.url === video.url)) {
                            allNostrVideos.push(video);
                            
                            // Extract categories from hashtags
                            if (video.hashtags && video.hashtags.length > 0) {
                                video.hashtags.forEach(tag => videoCategories.add(tag));
                            }
                        }
                    } else if (event.kind === 30023) { // Playlist
                        playlistCount++;
                        const playlist = processNostrPlaylist(event);
                        if (playlist && !allNostrPlaylists.find(p => p.id === playlist.id)) {
                            allNostrPlaylists.push(playlist);
                        }
                    }
                    
                    // Update UI periodically as content loads
                    if (eventCount % 50 === 0) {
                        console.log(`Processed ${eventCount} events: ${videoCount} videos, ${profileCount} profiles, ${playlistCount} playlists`);
                        updateHomepageContent();
                    }
                });

                // Handle end of events
                contentSubscription.on('eose', () => {
                    console.log(`Content loading complete!`);
                    console.log(`Final stats: ${videoCount} videos, ${profileCount} profiles, ${playlistCount} playlists`);
                    console.log(`Categories found: ${Array.from(videoCategories).join(', ')}`);
                    
                    isContentLoaded = true;
                    updateHomepageContent();
                    loadVideoFeed();
                    loadFromVineIntegration();
                });

                // Set timeout as fallback
                setTimeout(() => {
                    if (contentSubscription) {
                        console.log('Content loading timeout reached');
                        contentSubscription.unsub();
                        isContentLoaded = true;
                        updateHomepageContent();
                        loadVideoFeed();
                        loadFromVineIntegration();
                    }
                }, 15000);

            } catch (error) {
                console.error('Error loading Nostr content:', error);
                // Fallback to empty state
                isContentLoaded = true;
                updateHomepageContent();
                loadVideoFeed();
            }
        }

    
